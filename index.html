<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFè½¬å›¾ç‰‡å·¥å…· - å…¨èƒ½åˆ‡åˆ†ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); overflow: hidden; }
        header { background: linear-gradient(to right, #4a00e0, #8e2de2); color: white; padding: 30px; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        .main-content { display: flex; flex-direction: column; padding: 30px; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 30px; border: 2px dashed #8e2de2; text-align: center; transition: all 0.3s; }
        .upload-section:hover { border-color: #4a00e0; background: #f0f2f5; }
        .upload-area { padding: 30px; cursor: pointer; }
        .upload-icon { font-size: 60px; color: #8e2de2; margin-bottom: 15px; }
        .file-input { display: none; }
        
        /* æŒ‰é’® */
        .btn { background: linear-gradient(to right, #4a00e0, #8e2de2); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; margin: 10px 5px; display: inline-block; user-select: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: #a0a0a0; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: linear-gradient(to right, #ff7e5f, #feb47b); }
        
        /* é€‰é¡¹åŒºåŸŸ */
        .controls, .options { display: flex; justify-content: center; flex-wrap: wrap; margin: 20px 0; gap: 20px; }
        .option-group { display: flex; align-items: center; background: #f0f2f5; padding: 10px 20px; border-radius: 50px; }
        .option-group label { margin-right: 10px; font-weight: 500; }
        .option-group select, .option-group input[type="range"] { padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; background: white; }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-container { display: none; margin-top: 30px; }
        .preview-title { text-align: center; margin-bottom: 20px; color: #4a00e0; font-size: 1.5rem; }
        .images-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .image-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); transition: transform 0.3s; }
        .image-card:hover { transform: translateY(-5px); }
        .image-wrapper { padding: 15px; background: #f8f9fa; text-align: center; position: relative; touch-action: manipulation; }
        .converted-image { max-width: 100%; max-height: 400px; border-radius: 5px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); user-select: none; }
        
        /* åˆ‡å‰²çº¿æ ·å¼ (Xè½´ - å·¦å³) */
        .split-indicator-x {
            position: absolute; top: 0; bottom: 0; width: 2px;
            background: #ff4757; left: 50%;
            transform: translateX(-50%); cursor: col-resize; z-index: 10;
        }
        .split-indicator-x::before {
            content: 'â†”'; color: white; font-size: 12px; line-height: 40px; text-align: center;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 40px; background: #ff4757; border-radius: 3px;
        }
        
        /* åˆ‡å‰²çº¿æ ·å¼ (Yè½´ - ä¸Šä¸‹) */
        .split-indicator-y {
            position: absolute; left: 0; right: 0; height: 2px;
            background: #2ed573; top: 50%;
            transform: translateY(-50%); cursor: row-resize; z-index: 11;
        }
        .split-indicator-y::before {
            content: 'â†•'; color: white; font-size: 12px; line-height: 20px; text-align: center;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 20px; background: #2ed573; border-radius: 3px;
        }

        .image-info { padding: 15px; border-top: 1px solid #eee; }
        .image-info p { margin: 5px 0; font-size: 0.9rem; color: #666; }
        
        /* çŠ¶æ€ä¸æç¤º */
        .status { text-align: center; padding: 15px; margin: 20px 0; border-radius: 10px; display: none; }
        .status.processing { background: #e3f2fd; color: #1565c0; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .drag-info, .mobile-download-hint { text-align: center; margin: 10px 0; color: #666; font-size: 0.9rem; }
        .mobile-download-hint { display: none; background: #e3f2fd; padding: 10px; border-radius: 5px; color: #1565c0; }

        /* åˆ‡åˆ†é¢„è§ˆç½‘æ ¼ */
        .split-preview-grid { display: grid; gap: 15px; width: 100%; max-width: 800px; margin: 0 auto; }
        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
        .grid-rows-2 { grid-template-columns: 1fr; grid-template-rows: auto auto; max-width: 400px; } /* ä¸Šä¸‹åˆ‡åˆ†é™åˆ¶å®½åº¦ */
        .grid-cols-2-2 { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; }
        
        .split-item { border: 1px solid #ddd; padding: 10px; border-radius: 8px; text-align: center; background: #fff; }
        .split-item img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        
        .split-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px 0; }
        .split-position { font-weight: bold; color: #4a00e0; }

        @media (max-width: 768px) {
            .container { border-radius: 10px; }
            h1 { font-size: 2rem; }
            .images-container { grid-template-columns: 1fr; }
            .mobile-download-hint { display: block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PDFè½¬å›¾ç‰‡å·¥å…· - å…¨èƒ½åˆ‡åˆ†ç‰ˆ</h1>
            <p class="subtitle">æ”¯æŒ PDF/å›¾ç‰‡ è½¬å›¾ç‰‡ï¼Œæ”¯æŒå·¦å³ã€ä¸Šä¸‹ã€ç”°å­—æ ¼åˆ‡åˆ†</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“„/ğŸ–¼ï¸</div>
                    <h3>é€‰æ‹© PDF æ–‡ä»¶ æˆ– å¤šå¼ å›¾ç‰‡</h3>
                    <p>æ”¯æŒ PDFã€JPGã€PNGã€WebP (å¯æ‰¹é‡é€‰æ‹©)</p>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf, image/png, image/jpeg, image/jpg, image/webp" multiple>
                    <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </div>
            
            <div class="options">
                <div class="option-group">
                    <label for="imageFormat">æ ¼å¼:</label>
                    <select id="imageFormat">
                        <option value="png">PNG</option>
                        <option value="jpeg">JPEG</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="scale">ç¼©æ”¾:</label>
                    <input type="range" id="scale" min="0.5" max="3" step="0.1" value="2">
                    <span id="scaleValue">200%</span>
                </div>

                <div class="option-group" style="background: #e1bee7;">
                    <span style="margin-right:10px; font-weight:bold;">âœ‚ï¸ åˆ‡åˆ†æ¨¡å¼:</span>
                    <label style="cursor:pointer;"><input type="checkbox" id="enableSplitX" checked> å·¦å³</label>
                    <label style="margin-left:10px; cursor:pointer;"><input type="checkbox" id="enableSplitY" > ä¸Šä¸‹</label>
                </div>

                <div class="option-group" style="background: #e3f2fd;">
                    <label for="sharpenAmount">ğŸ” é”åŒ–:</label>
                    <input type="range" id="sharpenAmount" min="0" max="3" step="0.1" value="0">
                    <span id="sharpenValue">0</span>
                </div>
                
                <div class="option-group" style="background: #fff3e0;">
                    <label for="darkenAmount">âœ’ï¸ åŠ æ·±:</label>
                    <input type="range" id="darkenAmount" min="0" max="150" step="5" value="0">
                    <span id="darkenValue">0</span>
                </div>

                <div class="option-group" style="background: #f1f8e9;">
                    <label for="cleanAmount">ğŸ§¹ å‡€åŒ–:</label>
                    <input type="range" id="cleanAmount" min="150" max="250" step="1" value="200">
                    <span id="cleanValue">200</span>
                </div>
                <input type="hidden" id="imageQuality" value="0.95">
            </div>
            
            <div class="drag-info">
                <p>æç¤º: å‹¾é€‰ä¸åŒåˆ‡åˆ†æ¨¡å¼ä¼šå‡ºç°ä¸åŒæ–¹å‘çš„åˆ‡å‰²çº¿ï¼Œæ‹–åŠ¨çº¿æ¡å¯è°ƒæ•´ä½ç½®</p>
            </div>
            
            <div class="mobile-download-hint">
                <p>ğŸ’¡ ç§»åŠ¨ç«¯æç¤º: é•¿æŒ‰å›¾ç‰‡å¯é€‰æ‹©"ä¿å­˜å›¾åƒ"</p>
            </div>
            
            <div class="controls">
                <button class="btn" id="convertBtn" disabled>å¼€å§‹è½¬æ¢</button>
                <button class="btn" id="resetBtn" disabled>é‡ç½®</button>
            </div>
            
            <div class="preview-container" id="previewContainer">
                <h2 class="preview-title">è½¬æ¢ç»“æœ</h2>
                <div class="images-container" id="imagesContainer"></div>
                
                <div class="split-controls">
                    <button class="btn btn-secondary" id="prevSplitBtn">ä¸Šä¸€å¼ </button>
                    <span class="split-position">åˆ‡å‰²é¢„è§ˆ: <span id="currentSplit">1</span>/<span id="totalSplits">0</span></span>
                    <button class="btn btn-secondary" id="nextSplitBtn">ä¸‹ä¸€å¼ </button>
                </div>
                
                <div id="splitPreview"></div>

                <div class="controls">
                    <button class="btn" id="splitAllBtn" disabled>åˆ‡å‰²å…¨éƒ¨å›¾ç‰‡</button>
                </div>
                
                <div class="download-options">
                    <button class="btn" id="downloadAllBtn">ä¸‹è½½å…¨éƒ¨åŸå›¾</button>
                    <button class="btn" id="downloadSplitAllBtn">ä¸‹è½½å…¨éƒ¨åˆ‡ç‰‡</button>
                    <button class="btn btn-secondary" id="mergePdfBtn" disabled>åˆå¹¶åˆ‡ç‰‡ä¸ºPDF</button>
                </div>
            </div>

            <div class="status" id="statusMessage"></div>
        </div>
    </div>
    
    <footer>
        <p>Â© 2023 PDFè½¬å›¾ç‰‡å·¥å…· (ä¿®å¤ç‰ˆ)</p>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const convertBtn = document.getElementById('convertBtn');
        const splitAllBtn = document.getElementById('splitAllBtn');
        const resetBtn = document.getElementById('resetBtn');
        const uploadArea = document.getElementById('uploadArea');
        const statusMessage = document.getElementById('statusMessage');
        const previewContainer = document.getElementById('previewContainer');
        const imagesContainer = document.getElementById('imagesContainer');
        const imageFormatSelect = document.getElementById('imageFormat');
        const scaleSlider = document.getElementById('scale');
        const scaleValue = document.getElementById('scaleValue');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const downloadSplitAllBtn = document.getElementById('downloadSplitAllBtn');
        const splitPreview = document.getElementById('splitPreview');
        const prevSplitBtn = document.getElementById('prevSplitBtn');
        const nextSplitBtn = document.getElementById('nextSplitBtn');
        const currentSplitSpan = document.getElementById('currentSplit');
        const totalSplitsSpan = document.getElementById('totalSplits');
        const mergePdfBtn = document.getElementById('mergePdfBtn');
        
        // å¢å¼ºé€‰é¡¹
        const sharpenSlider = document.getElementById('sharpenAmount');
        const sharpenValueSpan = document.getElementById('sharpenValue');
        const darkenSlider = document.getElementById('darkenAmount');
        const darkenValueSpan = document.getElementById('darkenValue');
        const cleanSlider = document.getElementById('cleanAmount');
        const cleanValueSpan = document.getElementById('cleanValue');
        
        // åˆ‡åˆ†é€‰é¡¹
        const enableSplitXCb = document.getElementById('enableSplitX');
        const enableSplitYCb = document.getElementById('enableSplitY');
        
        let currentPdf = null;
        let convertedImages = [];
        let splitImages = [];
        let currentSplitIndex = 0;
        let selectedFiles = [];
        let processMode = 'pdf';
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // äº‹ä»¶ç›‘å¬
        selectFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        convertBtn.addEventListener('click', startProcessing);
        splitAllBtn.addEventListener('click', splitAllImages);
        resetBtn.addEventListener('click', resetConverter);
        scaleSlider.addEventListener('input', () => scaleValue.textContent = Math.round(scaleSlider.value * 100) + '%');
        downloadAllBtn.addEventListener('click', downloadAllImages);
        downloadSplitAllBtn.addEventListener('click', downloadAllSplitImages);
        prevSplitBtn.addEventListener('click', showPrevSplit);
        nextSplitBtn.addEventListener('click', showNextSplit);
        mergePdfBtn.addEventListener('click', mergeImagesToPdf);
        sharpenSlider.addEventListener('input', () => sharpenValueSpan.textContent = sharpenSlider.value);
        darkenSlider.addEventListener('input', () => darkenValueSpan.textContent = darkenSlider.value);
        cleanSlider.addEventListener('input', () => cleanValueSpan.textContent = cleanSlider.value);

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.backgroundColor = '#e3f2fd'; });
        uploadArea.addEventListener('dragleave', () => { uploadArea.style.backgroundColor = ''; });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            if (e.dataTransfer.files.length > 0) {
                // ä¿®å¤ Bugï¼šå˜é‡åæ›´æ­£ä¸º fileInput
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            if (fileInput.files.length === 0) return;
            selectedFiles = Array.from(fileInput.files);
            const firstFile = selectedFiles[0];
            
            if (firstFile.type === 'application/pdf') {
                processMode = 'pdf';
                if (selectedFiles.length > 1) {
                    showStatus('æ£€æµ‹åˆ° PDFï¼Œå°†ä»…å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶', 'processing');
                    selectedFiles = [firstFile];
                }
                const fileReader = new FileReader();
                fileReader.onload = function() { loadPdf(new Uint8Array(this.result)); };
                fileReader.readAsArrayBuffer(firstFile);
            } else if (firstFile.type.startsWith('image/')) {
                processMode = 'image';
                selectedFiles = selectedFiles.filter(f => f.type.startsWith('image/'));
                showStatus(`å·²å‡†å¤‡å¥½å¤„ç† ${selectedFiles.length} å¼ å›¾ç‰‡`, 'success');
                convertBtn.disabled = false;
                resetBtn.disabled = false;
            } else {
                showStatus('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
                return;
            }

            const infoText = processMode === 'pdf' ? 
                `${firstFile.name} (${(firstFile.size/1024/1024).toFixed(2)} MB)` : 
                `å·²é€‰æ‹© ${selectedFiles.length} å¼ å›¾ç‰‡`;
                
            uploadArea.innerHTML = `<div class="upload-icon">âœ…</div><h3>å·²é€‰æ‹©æ–‡ä»¶</h3><p>${infoText}</p><button class="btn" id="selectFileBtn">é‡æ–°é€‰æ‹©</button>`;
            document.getElementById('selectFileBtn').addEventListener('click', () => fileInput.click());
        }
        
        // åŠ è½½PDF (ä¿®å¤ Bugï¼šæ·»åŠ äº†è§£ç¦æŒ‰é’®çš„é€»è¾‘)
        function loadPdf(data) {
            showStatus('æ­£åœ¨åŠ è½½PDF...', 'processing');
            pdfjsLib.getDocument(data).promise.then(pdf => {
                currentPdf = pdf;
                showStatus(`PDFåŠ è½½æˆåŠŸï¼Œå…± ${pdf.numPages} é¡µ`, 'success');
                // ä¿®å¤ï¼šåŠ è½½æˆåŠŸåå¯ç”¨æŒ‰é’®
                convertBtn.disabled = false;
                resetBtn.disabled = false;
            }).catch(error => {
                console.error('Error loading PDF:', error);
                showStatus('åŠ è½½PDFå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®', 'error');
            });
        }

        // å¼€å§‹å¤„ç†
        function startProcessing() {
            if (processMode === 'pdf') convertPdfToImages();
            else processImages();
        }

        // PDFè½¬å›¾ç‰‡é€»è¾‘
        function convertPdfToImages() {
            if (!currentPdf) return;
            initProcessingState();
            
            const format = imageFormatSelect.value;
            const scale = parseFloat(scaleSlider.value);
            
            const convertPage = (pageNum) => {
                if (pageNum > currentPdf.numPages) {
                    finishProcessing();
                    return;
                }
                
                currentPdf.getPage(pageNum).then(page => {
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                        processCanvasAndStore(canvas, pageNum, format);
                        convertPage(pageNum + 1);
                    });
                }).catch(err => showStatus(`ç¬¬ ${pageNum} é¡µå‡ºé”™`, 'error'));
            };
            convertPage(1);
        }

        // å›¾ç‰‡å¤„ç†é€»è¾‘
        function processImages() {
            if (selectedFiles.length === 0) return;
            initProcessingState();
            
            const format = imageFormatSelect.value;
            const scale = parseFloat(scaleSlider.value);
            
            const processNext = (index) => {
                if (index >= selectedFiles.length) {
                    finishProcessing();
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const targetW = img.width * scale;
                        const targetH = img.height * scale;
                        canvas.width = targetW;
                        canvas.height = targetH;
                        canvas.getContext('2d').drawImage(img, 0, 0, targetW, targetH);
                        
                        processCanvasAndStore(canvas, index + 1, format);
                        processNext(index + 1);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(selectedFiles[index]);
            };
            processNext(0);
        }

        function initProcessingState() {
            showStatus('æ­£åœ¨å¤„ç†...', 'processing');
            convertedImages = [];
            splitImages = [];
            imagesContainer.innerHTML = '';
            splitPreview.innerHTML = '';
            currentSplitIndex = 0;
            totalSplitsSpan.textContent = '0';
        }

        function finishProcessing() {
            showStatus(`å®Œæˆï¼å…± ${convertedImages.length} å¼ å›¾ç‰‡`, 'success');
            previewContainer.style.display = 'block';
            splitAllBtn.disabled = false;
        }

        // é€šç”¨ç”»å¸ƒå¤„ç†ï¼šè£åˆ‡ -> å¢å¼º -> å­˜å‚¨ -> æ˜¾ç¤º
        function processCanvasAndStore(canvas, pageNum, format) {
            // 1. è‡ªåŠ¨è£ç™½è¾¹
            const trimmedCanvas = trimCanvas(canvas);
            
            // 2. å›¾åƒå¢å¼º
            const tCtx = trimmedCanvas.getContext('2d');
            const sAmount = parseFloat(sharpenSlider.value);
            const dAmount = parseFloat(darkenSlider.value);
            const cThreshold = parseFloat(cleanSlider.value);
            applyImageEnhancement(tCtx, trimmedCanvas.width, trimmedCanvas.height, sAmount, dAmount, cThreshold);
            
            // 3. å­˜å‚¨
            const quality = 0.95;
            const dataUrl = trimmedCanvas.toDataURL(`image/${format}`, quality);
            
            convertedImages.push({
                dataUrl: dataUrl,
                pageNum: pageNum,
                width: trimmedCanvas.width,
                height: trimmedCanvas.height,
                format: format,
                canvas: trimmedCanvas,
                splitX: 0.5, // åˆå§‹å·¦å³åˆ‡å‰²ä½ç½® 50%
                splitY: 0.5  // åˆå§‹ä¸Šä¸‹åˆ‡å‰²ä½ç½® 50%
            });

            // 4. æ˜¾ç¤º
            displayImage(dataUrl, pageNum, trimmedCanvas.width, trimmedCanvas.height);
        }

        // æ˜¾ç¤ºå•å¼ å›¾ç‰‡ (æ”¯æŒ XY åŒè½´åˆ‡å‰²çº¿)
        function displayImage(dataUrl, pageNum, width, height) {
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            
            const showX = enableSplitXCb.checked;
            const showY = enableSplitYCb.checked;
            
            let indicatorsHtml = '';
            if (showX) indicatorsHtml += `<div class="split-indicator-x" title="æ‹–åŠ¨è°ƒæ•´å·¦å³"></div>`;
            if (showY) indicatorsHtml += `<div class="split-indicator-y" title="æ‹–åŠ¨è°ƒæ•´ä¸Šä¸‹"></div>`;

            imageCard.innerHTML = `
                <div class="image-wrapper" style="position:relative;">
                    <img src="${dataUrl}" alt="ç¬¬${pageNum}é¡µ" class="converted-image" draggable="false">
                    ${indicatorsHtml}
                </div>
                <div class="image-info">
                    <p><strong>ç¬¬ ${pageNum} é¡µ</strong> (${width}x${height})</p>
                    <p id="pos-info-${pageNum}">
                        ${showX ? 'å·¦å³: 50% ' : ''} 
                        ${showY ? 'ä¸Šä¸‹: 50%' : ''}
                    </p>
                    <button class="btn btn-secondary split-single-btn" data-pagenum="${pageNum}">é¢„è§ˆåˆ‡å‰²</button>
                    <button class="btn download-single-btn" data-pagenum="${pageNum}">ä¸‹è½½åŸå›¾</button>
                </div>
            `;
            
            imagesContainer.appendChild(imageCard);
            
            const img = imageCard.querySelector('.converted-image');
            const infoSpan = document.getElementById(`pos-info-${pageNum}`);
            
            img.onload = function() {
                if (showX) setupDraggable(imageCard.querySelector('.split-indicator-x'), img, pageNum, 'x', infoSpan);
                if (showY) setupDraggable(imageCard.querySelector('.split-indicator-y'), img, pageNum, 'y', infoSpan);
            };

            imageCard.querySelector('.split-single-btn').addEventListener('click', () => splitSingleImage(pageNum));
            imageCard.querySelector('.download-single-btn').addEventListener('click', () => downloadSingleImage(pageNum));
        }

        // é€šç”¨æ‹–æ‹½é€»è¾‘ (XYè½´)
        function setupDraggable(element, img, pageNum, axis, infoDisplay) {
            let isDragging = false;
            
            const onStart = (e) => {
                e.preventDefault();
                isDragging = true;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, {passive: false});
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            };

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const rect = img.getBoundingClientRect();
                const clientPos = (e.touches ? e.touches[0] : e)[axis === 'x' ? 'clientX' : 'clientY'];
                const startPos = axis === 'x' ? rect.left : rect.top;
                const totalSize = axis === 'x' ? rect.width : rect.height;
                
                let percent = ((clientPos - startPos) / totalSize) * 100;
                percent = Math.max(5, Math.min(95, percent));
                
                element.style[axis === 'x' ? 'left' : 'top'] = percent + '%';
                
                const imgObj = convertedImages.find(i => i.pageNum == pageNum);
                if (imgObj) {
                    if (axis === 'x') imgObj.splitX = percent / 100;
                    else imgObj.splitY = percent / 100;
                    
                    const xText = enableSplitXCb.checked ? `å·¦å³: ${(imgObj.splitX*100).toFixed(0)}%` : '';
                    const yText = enableSplitYCb.checked ? `ä¸Šä¸‹: ${(imgObj.splitY*100).toFixed(0)}%` : '';
                    infoDisplay.textContent = `${xText} ${yText}`;
                }
            };

            const onEnd = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            };

            element.addEventListener('mousedown', onStart);
            element.addEventListener('touchstart', onStart, {passive: false});
        }

        // æ ¸å¿ƒåˆ‡åˆ†é€»è¾‘ (æ”¯æŒ å·¦å³ã€ä¸Šä¸‹ã€å››å®«æ ¼)
        function splitSingleImage(pageNum) {
            const imgObj = convertedImages.find(img => img.pageNum == pageNum);
            if (!imgObj) return;

            const doSplitX = enableSplitXCb.checked;
            const doSplitY = enableSplitYCb.checked;
            if (!doSplitX && !doSplitY) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§åˆ‡åˆ†æ¨¡å¼"); return; }

            const w = imgObj.width;
            const h = imgObj.height;
            const cutX = Math.floor(w * imgObj.splitX);
            const cutY = Math.floor(h * imgObj.splitY);

            let regions = [];
            if (doSplitX && doSplitY) {
                regions = [
                    { name: 'å·¦ä¸Š', suffix: '_TL', x: 0,    y: 0,    w: cutX,     h: cutY },
                    { name: 'å³ä¸Š', suffix: '_TR', x: cutX, y: 0,    w: w - cutX, h: cutY },
                    { name: 'å·¦ä¸‹', suffix: '_BL', x: 0,    y: cutY, w: cutX,     h: h - cutY },
                    { name: 'å³ä¸‹', suffix: '_BR', x: cutX, y: cutY, w: w - cutX, h: h - cutY }
                ];
            } else if (doSplitX) {
                regions = [
                    { name: 'å·¦', suffix: '_L', x: 0,    y: 0, w: cutX,     h: h },
                    { name: 'å³', suffix: '_R', x: cutX, y: 0, w: w - cutX, h: h }
                ];
            } else if (doSplitY) {
                regions = [
                    { name: 'ä¸Š', suffix: '_T', x: 0, y: 0,    w: w, h: cutY },
                    { name: 'ä¸‹', suffix: '_B', x: 0, y: cutY, w: w, h: h - cutY }
                ];
            }

            const format = imageFormatSelect.value;
            const parts = regions.map(r => {
                const canvas = document.createElement('canvas');
                canvas.width = r.w;
                canvas.height = r.h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgObj.canvas, r.x, r.y, r.w, r.h, 0, 0, r.w, r.h);
                return {
                    name: r.name,
                    suffix: r.suffix,
                    width: r.w,
                    height: r.h,
                    dataUrl: canvas.toDataURL(`image/${format}`, 0.95)
                };
            });

            const resultObj = { originalPage: pageNum, parts: parts };
            const existIdx = splitImages.findIndex(s => s.originalPage === pageNum);
            if (existIdx !== -1) splitImages[existIdx] = resultObj;
            else splitImages.push(resultObj);

            currentSplitIndex = splitImages.findIndex(s => s.originalPage === pageNum);
            updateSplitPreview(currentSplitIndex);
            
            totalSplitsSpan.textContent = splitImages.length;
            currentSplitSpan.textContent = currentSplitIndex + 1;
            mergePdfBtn.disabled = false;
            showStatus(`ç¬¬ ${pageNum} é¡µåˆ‡å‰²å®Œæˆ (${parts.length}å¼ )`, 'success');
        }

        function splitAllImages() {
            if (convertedImages.length === 0) return;
            showStatus('æ­£åœ¨åˆ‡å‰²æ‰€æœ‰å›¾ç‰‡...', 'processing');
            splitImages = [];
            convertedImages.forEach(img => splitSingleImage(img.pageNum));
            showStatus(`æ‰€æœ‰å›¾ç‰‡åˆ‡å‰²å®Œæˆï¼Œå…± ${splitImages.length} ç»„`, 'success');
        }

        // æ›´æ–°é¢„è§ˆè§†å›¾
        function updateSplitPreview(index) {
            if (index < 0 || index >= splitImages.length) return;
            const item = splitImages[index];
            const parts = item.parts;

            let gridClass = '';
            if (parts.length === 4) gridClass = 'grid-cols-2-2';
            else if (enableSplitYCb.checked && !enableSplitXCb.checked) gridClass = 'grid-rows-2';
            else gridClass = 'grid-cols-2';

            let html = `<div class="split-preview-grid ${gridClass}">`;
            parts.forEach(part => {
                html += `
                    <div class="split-item">
                        <div style="font-weight:bold; margin-bottom:5px;">${part.name}</div>
                        <img src="${part.dataUrl}">
                        <div style="font-size:12px; margin-top:5px; color:#666;">${part.width}x${part.height}</div>
                    </div>
                `;
            });
            html += `</div>`;
            splitPreview.innerHTML = html;
        }

        function showPrevSplit() {
            if (splitImages.length === 0) return;
            currentSplitIndex = (currentSplitIndex - 1 + splitImages.length) % splitImages.length;
            updateSplitPreview(currentSplitIndex);
            currentSplitSpan.textContent = currentSplitIndex + 1;
        }

        function showNextSplit() {
            if (splitImages.length === 0) return;
            currentSplitIndex = (currentSplitIndex + 1) % splitImages.length;
            updateSplitPreview(currentSplitIndex);
            currentSplitSpan.textContent = currentSplitIndex + 1;
        }

        // ä¸‹è½½åŸå›¾
        function downloadSingleImage(pageNum) {
            const image = convertedImages.find(img => img.pageNum == pageNum);
            if (!image) return;
            saveFile(image.dataUrl, `åŸå›¾_é¡µ${pageNum}.${image.format}`);
        }
        
        function downloadAllImages() {
            if (isMobileDevice) {
                alert("ç§»åŠ¨ç«¯è¯·é€å¼ é•¿æŒ‰ä¿å­˜");
                return;
            }
            convertedImages.forEach(img => saveFile(img.dataUrl, `åŸå›¾_é¡µ${img.pageNum}.${img.format}`));
        }

        // ä¸‹è½½åˆ‡ç‰‡
        function downloadAllSplitImages() {
            if (splitImages.length === 0) { showStatus('æ— åˆ‡ç‰‡æ•°æ®', 'error'); return; }
            if (isMobileDevice) { alert("ç§»åŠ¨ç«¯è¯·é€å¼ é•¿æŒ‰ä¿å­˜"); return; }
            
            splitImages.forEach(item => {
                item.parts.forEach(part => {
                    saveFile(part.dataUrl, `é¡µ${item.originalPage}${part.suffix}.${imageFormatSelect.value}`);
                });
            });
        }

        function saveFile(dataUrl, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            link.click();
        }

        // åˆå¹¶PDF (æ”¯æŒä»»æ„æ•°é‡åˆ‡ç‰‡)
        async function mergeImagesToPdf() {
            if (splitImages.length === 0) return;
            const { jsPDF } = window.jspdf;
            
            const totalParts = splitImages.reduce((s, i) => s + i.parts.length, 0);
            showStatus(`æ­£åœ¨åˆå¹¶ ${totalParts} å¼ åˆ‡ç‰‡åˆ°PDF...`, 'processing');
            
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            let isFirstPage = true;
            const a4W = doc.internal.pageSize.getWidth();
            const a4H = doc.internal.pageSize.getHeight();
            const margin = 5; 
            const effW = a4W - 2 * margin; 
            const effH = a4H - 2 * margin; 

            for (let i = 0; i < splitImages.length; i++) {
                for (const part of splitImages[i].parts) {
                    const img = new Image();
                    img.src = part.dataUrl;
                    await new Promise(r => img.onload = r);
                    
                    const scale = Math.min(effW / img.width, effH / img.height);
                    const tW = img.width * scale;
                    const tH = img.height * scale;
                    const x = (a4W - tW) / 2;
                    const y = (a4H - tH) / 2;

                    if (!isFirstPage) doc.addPage();
                    isFirstPage = false;
                    
                    let format = 'JPEG';
                    if (part.dataUrl.startsWith('data:image/png')) format = 'PNG';
                    if (part.dataUrl.startsWith('data:image/webp')) format = 'WEBP';
                    
                    doc.addImage(part.dataUrl, format, x, y, tW, tH, null, 'FAST');
                }
            }
            const now = new Date();
            const fileName = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            doc.save(`Merged-${fileName}.pdf`);
            showStatus(`PDFåˆå¹¶å®Œæˆ!`, 'success');
        }

        // å›¾åƒç®—æ³•å·¥å…·å‡½æ•°
        function trimCanvas(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const w = canvas.width, h = canvas.height;
            const PADDING = 30;
            const data = ctx.getImageData(0, 0, w, h).data;
            let top = h, bottom = 0, left = w, right = 0, found = false;
            
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    if (data[i+3] > 0 && (data[i] < 250 || data[i+1] < 250 || data[i+2] < 250)) {
                        if (x < left) left = x; if (x > right) right = x;
                        if (y < top) top = y; if (y > bottom) bottom = y;
                        found = true;
                    }
                }
            }
            if (!found) return canvas; // çº¯ç™½ä¸è£
            
            const cW = right - left + 1, cH = bottom - top + 1;
            const tCanvas = document.createElement('canvas');
            tCanvas.width = cW + PADDING * 2; tCanvas.height = cH + PADDING * 2;
            const tCtx = tCanvas.getContext('2d');
            tCtx.fillStyle = '#fff'; tCtx.fillRect(0, 0, tCanvas.width, tCanvas.height);
            tCtx.drawImage(canvas, left, top, cW, cH, PADDING, PADDING, cW, cH);
            return tCanvas;
        }

        function applyImageEnhancement(ctx, w, h, sVal, dVal, cVal) {
            if (sVal <= 0 && dVal <= 0 && cVal >= 254) return;
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;
            const copy = sVal > 0 ? new Uint8ClampedArray(data) : null;
            
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    let r = data[i], g = data[i+1], b = data[i+2];
                    
                    if (sVal > 0 && x > 0 && y > 0 && x < w-1 && y < h-1) {
                        const up = ((y-1)*w+x)*4, down = ((y+1)*w+x)*4, left = (y*w+x-1)*4, right = (y*w+x+1)*4;
                        const rA = (copy[up]+copy[down]+copy[left]+copy[right])/4;
                        const gA = (copy[up+1]+copy[down+1]+copy[left+1]+copy[right+1])/4;
                        const bA = (copy[up+2]+copy[down+2]+copy[left+2]+copy[right+2])/4;
                        r += (r - rA) * sVal; g += (g - gA) * sVal; b += (b - bA) * sVal;
                    }
                    
                    if ((r+g+b)/3 > cVal) { r=255; g=255; b=255; }
                    else if (dVal > 0) { r -= dVal; g -= dVal; b -= dVal; }
                    
                    data[i] = r; data[i+1] = g; data[i+2] = b;
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function resetConverter() {
            fileInput.value = ''; currentPdf = null; selectedFiles = []; processMode = 'pdf';
            initProcessingState();
            previewContainer.style.display = 'none';
            convertBtn.disabled = true; splitAllBtn.disabled = true; resetBtn.disabled = true;
            uploadArea.innerHTML = `<div class="upload-icon">ğŸ“„/ğŸ–¼ï¸</div><h3>é€‰æ‹© PDF æ–‡ä»¶ æˆ– å¤šå¼ å›¾ç‰‡</h3><p>æ”¯æŒ PDFã€JPGã€PNGã€WebP (å¯æ‰¹é‡é€‰æ‹©)</p><button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>`;
            document.getElementById('selectFileBtn').addEventListener('click', () => fileInput.click());
            showStatus('', '');
        }

        function showStatus(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.className = 'status ' + (type || '');
            statusMessage.style.display = type ? 'block' : 'none';
        }
    </script>
</body>
</html>
